import Le,{useState as ve,useCallback as Ne,forwardRef as Me}from"react";import We from"next/image";import{getTransformations as Ve}from"@cloudinary-util/util";import{transformationPlugins as De}from"@cloudinary-util/url-loader";import be from"next/package.json";var pe={name:"next-cloudinary",version:"6.5.1",license:"MIT",main:"./dist/index.js",module:"./dist/index.mjs",types:"./dist/index.d.ts",source:"src/index.ts",scripts:{build:"tsup",dev:"tsup --watch",prepublishOnly:"cp ../README.md . && cp ../LICENSE . && pnpm build",postpublish:"rm ./README.md && rm ./LICENSE",test:"vitest run","test:app":'NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME="test" pnpm build && cd tests/nextjs-app && npm install && npm run build',"test:watch":"vitest"},dependencies:{"@cloudinary-util/types":"1.0.2","@cloudinary-util/url-loader":"5.2.2","@cloudinary-util/util":"^3.0.0","@tsconfig/recommended":"^1.0.3"},devDependencies:{"@babel/core":"^7.23.2","@babel/preset-env":"^7.23.2","@types/node":"^20.11.5","@types/react":"^18.2.33","@types/react-dom":"^18.2.14",dotenv:"^16.3.1",mkdirp:"^3.0.1",tsup:"^7.2.0",typescript:"^5.2.2",vitest:"^1.3.1"},peerDependencies:{next:"^12 || ^13 || ^14",react:"^17 || ^18"}};var ue="A",ce="V",ge=me(be.version),fe=me(pe.version);function me(e){let t=e;return t.includes("-")&&(t=t.split("-")[0]),t}async function H(e){let{src:t}=e;try{await new Promise((i,a)=>{fetch(t).then(o=>{if(!o.ok){a(o);return}i(o)})})}catch(i){return i.status===423?(await new Promise(a=>setTimeout(()=>a(void 0),200)),await H(e)):!1}return!0}function x(e){let t=e?.cloud?.cloudName??process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;if(!t)throw new Error("A Cloudinary Cloud name is required, please make sure NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME is set and configured in your environment.");let i=e?.cloud?.apiKey??process.env.NEXT_PUBLIC_CLOUDINARY_API_KEY,a=e?.url?.secureDistribution??process.env.NEXT_PUBLIC_CLOUDINARY_SECURE_DISTRIBUTION,o=e?.url?.privateCdn??process.env.NEXT_PUBLIC_CLOUDINARY_PRIVATE_CDN;return Object.assign({cloud:{...e?.cloud,apiKey:i,cloudName:t},url:{...e?.url,secureDistribution:a,privateCdn:o}},e)}function Y(e){return Object.assign({product:ue,sdkCode:ce,sdkSemver:fe,techVersion:ge,feature:""},e)}import{constructCloudinaryUrl as Ae}from"@cloudinary-util/url-loader";function E(e,t,i){return Ae({options:e,config:x(t),analytics:Y(i)})}function ee({loaderOptions:e,imageProps:t,cldOptions:i,cldConfig:a={}}){let o={...t,...i};if(o.width=typeof o.width=="string"?parseInt(o.width):o.width,o.height=typeof o.height=="string"?parseInt(o.height):o.height,typeof e?.width=="number"&&typeof o.width=="number"&&e.width!==o.width){let n=e.width/o.width;o.width=e.width,typeof o.height=="number"&&(o.height=Math.floor(o.height*n))}else typeof e?.width=="number"&&typeof o?.width!="number"&&(o.width=e?.width);return E(o,a)}var Se=Me(function(t,i){let a=!1,o=["deliveryType","preserveTransformations","strictTransformations","assetType"];De.forEach(({props:r})=>{Object.keys(r).forEach(C=>{if(o.includes(C))throw new Error(`Option ${C} already exists!`);o.push(C)})});let n={alt:t.alt,src:t.src};Object.keys(t).filter(r=>typeof r=="string"&&!o.includes(r)).forEach(r=>n[r]=t[r]);let s=Object.keys(n).map(r=>`${r}:${n[r]}`).join(";"),[f,I]=ve(s),d={};if(o.forEach(r=>{let c=t[r];c&&(d[r]=c||void 0)}),t.preserveTransformations)try{let r=Ve(t.src).map(c=>c.join(","));d.rawTransformations=[...r.flat(),...t.rawTransformations||[]]}catch(r){console.warn(`Failed to preserve transformations: ${r.message}`)}let p=process.env.__NEXT_IMAGE_OPTS||{};(t.unoptimized===!0||p?.unoptimized===!0)&&(n.src=E({...d,width:n.width,height:n.height,src:n.src,format:"default",quality:"default"},t.config));async function y(r){let c=!0;if(a)return;if(a=!0,typeof t.onError=="function"){let w=t.onError(r);typeof w=="boolean"&&w===!1&&(c=!1)}else typeof t.onError=="boolean"&&t.onError===!1&&(c=!1);if(c===!1)return;let C=r.target;await H({src:C.src})&&I(`${s};${Date.now()}`)}let b=Ne(y,[H,s]),h=We;return"default"in h&&(h=h.default),Le.createElement(h,{key:f,...n,loader:r=>ee({loaderOptions:r,imageProps:n,cldOptions:d,cldConfig:t.config}),onError:b,ref:i})}),ye=Se;import P from"react";import ke from"next/head";function X(e){return E({...e,format:e.format||"jpg",width:e.width||1200,height:e.height||627,crop:e.crop||{type:"fill",gravity:"center",source:!0}})}var Ge="summary_large_image",Re=({excludeTags:e=[],twitterTitle:t,keys:i={},...a})=>{let{alt:o}=a,{width:n=1200,height:s=627}=a;n=typeof n=="string"?parseInt(n):n,s=typeof s=="string"?parseInt(s):s;let f=X({...a,width:n,height:s}),I=X({...a,width:n,height:s,format:a.format||"webp"}),d={"og:image":"og-image","og:image:secure_url":"og-image-secureurl","og:image:width":"og-image-width","og:image:height":"og-image-height","og:image:alt":"og-image-alt","twitter:title":"twitter-title","twitter:card":"twitter-card","twitter:image":"twitter-image",...i};return P.createElement(ke,null,P.createElement("meta",{key:d["og:image"],property:"og:image",content:f}),P.createElement("meta",{key:d["og:image:secure_url"],property:"og:image:secure_url",content:f}),P.createElement("meta",{key:d["og:image:width"],property:"og:image:width",content:`${n}`}),P.createElement("meta",{key:d["og:image:height"],property:"og:image:height",content:`${s}`}),o&&P.createElement("meta",{key:d["og:image:alt"],property:"og:image:alt",content:o}),!e.includes("twitter:title")&&P.createElement("meta",{key:d["twitter:title"],property:"twitter:title",content:t||" "}),P.createElement("meta",{key:d["twitter:card"],property:"twitter:card",content:Ge}),P.createElement("meta",{key:d["twitter:image"],property:"twitter:image",content:I}))},Ce=Re;import q from"react";import re,{useState as ne,useEffect as he,useRef as Oe}from"react";import je from"next/script";function Ie(e){return window&&"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(()=>e(),1)}var $e=["success"],Be={abort:"onAbort","batch-cancelled":"onBatchCancelled",close:"onClose","display-changed":"onDisplayChanged",publicid:"onPublicId","queues-end":"onQueuesEnd","queues-start":"onQueuesStart",retry:"onRetry","show-completed":"onShowCompleted","source-changed":"onSourceChanged",success:"onSuccess",tags:"onTags","upload-added":"onUploadAdded"},He=({children:e,config:t,onError:i,onOpen:a,onUpload:o,options:n,signatureEndpoint:s,uploadPreset:f,...I})=>{let d=Oe(),p=Oe(),y=!!s,[b,h]=ne(void 0),[r,c]=ne(void 0),[C,W]=ne(!0),w=x(t),{cloudName:G,apiKey:O}=w?.cloud,T={cloudName:G,uploadPreset:f||process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET,apiKey:O,...n};y&&(T.uploadSignature=A,T.apiKey||console.warn("Missing dependency: Signed Upload requires an API key")),he(()=>{if(typeof r>"u")return;r.event==="success"&&typeof o=="function"&&(process.env.NODE_ENVIRONMENT==="development"&&console.warn("The onUpload callback is deprecated. Please use onSuccess instead."),o(r,p.current))},[r]);function V(){W(!1),d.current||(d.current=window.cloudinary),Ie(()=>{p.current||(p.current=J())})}he(()=>()=>{p.current?.destroy(),p.current=void 0},[]);function A(l,m){if(typeof s>"u")throw Error("Failed to generate signature: signatureEndpoint undefined.");fetch(s,{method:"POST",body:JSON.stringify({paramsToSign:m}),headers:{"Content-Type":"application/json"}}).then(U=>U.json()).then(({signature:U})=>{l(U)})}function g(l,m=[]){if(p.current||(p.current=J()),typeof p?.current[l]=="function")return p.current[l](...m)}function _(l){g("close",[l])}function D(l){return g("destroy",[l])}function $(){g("hide")}function L(){return g("isDestroyed")}function B(){return g("isMinimized")}function K(){return g("isShowing")}function R(){g("minimize")}function Q(l,m){g("open",[l,m]),typeof a=="function"&&a(p.current)}function S(){g("show")}function v(){g("update")}let N={close:_,destroy:D,hide:$,isDestroyed:L,isMinimized:B,isShowing:K,minimize:R,open:Q,show:S,update:v};function J(){return d.current?.createUploadWidget(T,(l,m)=>{if(l&&l!==null&&(h(l),typeof i=="function"&&i(l,{widget:p.current,...N})),typeof m?.event=="string"){$e.includes(m?.event)&&c(m);let U=Be[m.event];if(typeof U=="string"&&typeof I[U]=="function"){let Z=I[U];Z(m,{widget:p.current,...N})}}})}return re.createElement(re.Fragment,null,typeof e=="function"&&e({cloudinary:d.current,widget:p.current,results:r,error:b,isLoading:C,...N}),re.createElement(je,{id:`cloudinary-uploadwidget-${Math.floor(Math.random()*100)}`,src:"https://upload-widget.cloudinary.com/global/all.js",onLoad:V,onError:l=>console.error(`Failed to load Cloudinary Upload Widget: ${l.message}`)}))},F=He;var Ye=({className:e,children:t,onClick:i,onError:a,onOpen:o,onUpload:n,onAbort:s,onBatchCancelled:f,onClose:I,onDisplayChanged:d,onPublicId:p,onQueuesEnd:y,onQueuesStart:b,onRetry:h,onShowCompleted:r,onSourceChanged:c,onSuccess:C,onTags:W,onUploadAdded:w,options:G,signatureEndpoint:O,uploadPreset:T,...V})=>q.createElement(q.Fragment,null,q.createElement(F,{onError:a,onOpen:o,onUpload:n,onAbort:s,onBatchCancelled:f,onClose:I,onDisplayChanged:d,onPublicId:p,onQueuesEnd:y,onQueuesStart:b,onRetry:h,onShowCompleted:r,onSourceChanged:c,onSuccess:C,onTags:W,onUploadAdded:w,options:G,signatureEndpoint:O,uploadPreset:T},({open:A,isLoading:g})=>{function _(D){D.preventDefault(),A(),typeof i=="function"&&i(D)}return q.createElement("button",{...V,className:e||"",onClick:_,disabled:g},t||"Upload")})),Ue=Ye;import M,{useRef as ae,useEffect as Fe}from"react";import qe from"next/script";import ze from"next/head";import{parseUrl as Ke}from"@cloudinary-util/util";import{constructCloudinaryUrl as Xe}from"@cloudinary-util/url-loader";function ie(e,t,i){return Xe({options:{assetType:"video",format:"auto:video",...e},config:x(t),analytics:Y(i)})}var z=[],Ee="1.11.1",Qe=e=>{let{autoplay:t,className:i,colors:a,config:o,controls:n=!0,fontFace:s,height:f,id:I,language:d,languages:p,logo:y=!0,loop:b=!1,muted:h=!1,onDataLoad:r,onError:c,onMetadataLoad:C,onPause:W,onPlay:w,onEnded:G,poster:O,src:T,sourceTypes:V,transformation:A,quality:g="auto",width:_,...D}=e,$=Array.isArray(A)?A:[A],L=T||"";if(L.startsWith("http"))try{let u=Ke(T);typeof u?.publicId=="string"&&(L=u?.publicId)}catch{}$.unshift({quality:g});let B=ae(),K=ae(),R=e.videoRef||K,Q=ae(),S=e.playerRef||Q,v=I||`player-${L.replace("/","-")}`,N="cld-video-player cld-fluid";i&&(N=`${N} ${i}`),z.filter(u=>u===v).length>1?console.warn(`Multiple instances of the same video detected on the
     page which may cause some features to not work.
    Try adding a unique id to each player.`):z.push(v);let l={error:c,loadeddata:r,loadedmetadata:C,pause:W,play:w,ended:G};function m(u){let j=l[u.type];typeof j=="function"&&j(Z())}function U(){if("cloudinary"in window){B.current=window.cloudinary;let u={};typeof y=="boolean"?u.showLogo=y:typeof y=="object"&&(u={...u,showLogo:!0,logoImageUrl:y.imageUrl,logoOnclickUrl:y.onClickUrl});let j=!1,de;(typeof t=="boolean"||t==="true"||t==="false")&&(j=t),typeof t=="string"&&t!=="true"&&t!=="false"&&(de=t);let le=x(o),{cloudName:we}=le?.cloud,{secureDistribution:Te,privateCdn:_e}=le?.url,k={cloud_name:we,privateCdn:_e,secureDistribution:Te,autoplayMode:de,autoplay:j,controls:n,fontFace:s||"",language:d,languages:p,loop:b,muted:h,publicId:L,width:_,height:f,aspectRatio:`${_}:${f}`,transformation:$,...u,...D};Array.isArray(V)&&(k.sourceTypes=V),typeof a=="object"&&(k.colors=a),typeof O=="string"?k.posterOptions={publicId:O}:typeof O=="object"&&(typeof O.src!="string"?k.posterOptions={publicId:ie({...O,src:L,format:"auto:image"})}:k.posterOptions={publicId:E(O)}),S.current=B.current.videoPlayer(R.current,k),Object.keys(l).forEach(se=>{typeof l[se]=="function"&&S.current?.on(se,m)})}}Fe(()=>()=>{S.current?.videojs.cloudinary.dispose(),z=z.filter(u=>u!==v)},[]);function Z(){return{player:S.current,video:R.current}}return M.createElement(M.Fragment,null,M.createElement(ze,null,M.createElement("link",{href:`https://unpkg.com/cloudinary-video-player@${Ee}/dist/cld-video-player.min.css`,rel:"stylesheet"})),M.createElement("div",{style:{width:"100%",aspectRatio:`${_} / ${f}`}},M.createElement("video",{ref:R,id:v,className:N,width:_,height:f}),M.createElement(qe,{id:`cloudinary-videoplayer-${v}-${Math.floor(Math.random()*100)}`,src:`https://unpkg.com/cloudinary-video-player@${Ee}/dist/cld-video-player.min.js`,onLoad:U,onError:u=>console.error(`Failed to load Cloudinary Video Player: ${u.message}`)})))},Pe=Qe;export{ye as CldImage,Ce as CldOgImage,Ue as CldUploadButton,F as CldUploadWidget,Pe as CldVideoPlayer,ee as cloudinaryLoader,E as getCldImageUrl,X as getCldOgImageUrl,ie as getCldVideoUrl};
//# sourceMappingURL=index.mjs.map